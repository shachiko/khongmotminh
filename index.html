<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Không Một Mình – Cùng nhau an toàn trực tuyến</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
        }
        .quiz-option:hover {
            background-color: #DBEAFE; /* Light blue on hover */
        }
        .quiz-option.selected {
            background-color: #93C5FD; /* Darker blue when selected */
            border-color: #2563EB;
        }
        .quiz-option.correct {
            background-color: #D1FAE5;
            border-color: #059669;
            color: #047857;
            font-weight: bold;
        }
        .quiz-option.incorrect {
            background-color: #FEE2E2;
            border-color: #E11D48;
            color: #BE123C;
        }
        #quiz-container.submitted .quiz-option {
            pointer-events: none;
            cursor: default;
        }
        /* Style for theory sections */
        .theory-section {
            margin-top: 1.5rem; /* Reduced margin */
            padding-top: 1rem; /* Reduced padding */
            /* border-top: 1px solid #e5e7eb; Removed border for continuous flow */
        }
        .theory-section h4 {
             margin-top: 1.5rem; /* mt-6 */
             margin-bottom: 0.75rem; /* mb-3 */
             font-size: 1.25rem; /* text-xl */
             font-weight: 700; /* font-bold */
        }
         .theory-section h5 {
             margin-top: 1rem; /* mt-4 */
             margin-bottom: 0.5rem; /* mb-2 */
             font-size: 1.125rem; /* text-lg */
             font-weight: 600; /* font-semibold */
         }
        /* Thêm style cho bảng */
        .theory-table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
        }
        .theory-table th, .theory-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        .theory-table th {
            background-color: #f3f4f6;
            font-weight: 700;
        }
        .theory-table td:first-child {
            font-weight: 700;
            width: 20%;
        }

    </style>
</head>
<body class="bg-blue-50 text-gray-800 flex flex-col min-h-screen">

    <div id="app" class="container mx-auto p-4 max-w-4xl flex flex-col flex-grow">

        <header class="text-center my-8">
            <img id="logo" src="logo-tron.png" alt="Logo Không Một Mình" class="w-20 h-20 mx-auto mb-4 rounded-full"
                 onerror="this.onerror=null;this.src='https://placehold.co/100x100/FFFFFF/00529D?text=Logo';">
            <h1 class="text-4xl font-bold text-blue-800">Không Một Mình</h1>
            <p class="text-lg text-blue-600">Cùng nhau an toàn trực tuyến</p>
        </header>

        <main id="main-content" class="flex-grow flex items-center justify-center">
            <div id="registration-view" class="bg-white p-8 rounded-xl shadow-lg text-center w-full">
                <img id="banner" src="Kmm-01.jpg" alt="Banner Chiến dịch" class="w-full h-64 object-cover rounded-lg mb-6"
                     onerror="this.onerror=null;this.src='https://placehold.co/800x400/00529D/FFFFFF?text=Banner';">
                <h2 class="text-2xl font-bold mb-4">Tham gia Thử thách Bảo vệ</h2>
                <p class="mb-6">Hãy điền thông tin để bắt đầu bài kiểm tra hàng tuần và tích luỹ cúp nhé!</p>
                <form id="registration-form" class="space-y-4 max-w-sm mx-auto">
                    <input type="text" id="student-name" placeholder="Họ và tên của bạn" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="email" id="student-email" placeholder="Email nhận chứng nhận" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="text" id="student-class" placeholder="Lớp" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">BẮT ĐẦU TUẦN 3</button>
                </form>
            </div>

            <div id="theory-view" class="hidden bg-white p-8 rounded-xl shadow-lg w-full">
                <h2 id="theory-title" class="text-2xl font-bold mb-4 text-center">Kiến thức Tuần 3</h2> <div id="theory-content" class="text-left mb-6 space-y-4 max-h-[60vh] overflow-y-auto pr-4">
                    </div>
                <button id="start-quiz-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors">Đã hiểu, Bắt đầu làm bài</button>
            </div>

            <div id="quiz-view" class="hidden bg-white p-8 rounded-xl shadow-lg w-full">
                <h2 id="quiz-title" class="text-2xl font-bold mb-2 text-center">Bài kiểm tra Tuần 3</h2> <p id="quiz-description" class="text-center mb-6">Chọn câu trả lời đúng nhất.</p>
                <div id="quiz-container" class="space-y-6"></div>
                <button id="submit-quiz" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400">Nộp bài</button>
            </div>
        </main>
    </div>

    <footer class="text-center py-6 text-sm text-gray-500">
        <p>&copy; 2025 - Sản phẩm thuộc bản quyền của trường UK ACADEMY HA LONG</p>
    </footer>

    <div id="result-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full relative transform transition-all scale-95 opacity-0" id="result-content">
            <div id="normal-result-content">
                <h2 id="result-title" class="text-3xl font-bold text-yellow-500 mb-4"></h2>
                <div id="cup-container" class="my-4">
                    <svg class="w-32 h-32 mx-auto text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM8 16a2 2 0 114 0H8z"></path><path fill-rule="evenodd" d="M10 0a1 1 0 011 1v.065a8.002 8.002 0 015.657 5.657A1 1 0 0117 8v3.586l1.707 1.707a1 1 0 01-1.414 1.414L16 13.414V8a6.002 6.002 0 00-5-5.917V1a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                </div>
                <p id="result-message" class="text-xl font-semibold text-gray-700 my-4"></p>
                <p id="result-score" class="text-lg mb-6"></p>
                <button id="continue-btn-fail" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors mt-4">Tiếp tục làm lại</button>
            </div>

            <div id="robot-message-content" class="hidden">
                <img src="robot-uka.png" alt="Robot UKA Hạ Long" class="w-40 h-40 mx-auto mb-4 object-contain"
                     onerror="this.onerror=null;this.src='https://placehold.co/150x150/FFFFFF/00529D?text=Robot';">
                <p id="robot-congrats-text" class="text-xl font-bold text-blue-700 mb-4"></p>
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="share-fb-2" class="bg-blue-800 text-white font-bold py-2 px-5 rounded-lg">Chia sẻ Facebook</button>
                    <button id="share-zalo-2" class="bg-blue-500 text-white font-bold py-2 px-5 rounded-lg">Chia sẻ Zalo</button>
                </div>
                <button id="continue-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors mt-4">Tiếp tục</button>
            </div>
            
            <button id="close-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
        </div>
    </div>
    
    <canvas id="fireworks-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script>
        // DOM Elements
        const registrationView = document.getElementById('registration-view');
        const theoryView = document.getElementById('theory-view');
        const quizView = document.getElementById('quiz-view');
        const resultModal = document.getElementById('result-modal');
        const resultContent = document.getElementById('result-content');
        const normalResultContent = document.getElementById('normal-result-content');
        const robotMessageContent = document.getElementById('robot-message-content');
        const registrationForm = document.getElementById('registration-form');
        const quizContainer = document.getElementById('quiz-container');
        const submitQuizBtn = document.getElementById('submit-quiz');
        const closeModalBtn = document.getElementById('close-modal');
        const continueBtn = document.getElementById('continue-btn');
        const continueBtnFail = document.getElementById('continue-btn-fail');
        const fireworksCanvas = document.getElementById('fireworks-canvas');
        const theoryContent = document.getElementById('theory-content');
        const theoryTitle = document.getElementById('theory-title');
        const startQuizBtn = document.getElementById('start-quiz-btn');

        // State
        let studentInfo = { name: '', email: '', class: '' };
        // Giữ nguyên key 'week1' vì chỉ có 1 bộ dữ liệu, nhưng sẽ gửi 'week2' sang Apps Script
        let currentQuizKey = 'week1'; 
        let currentQuiz = {};
        let userAnswers = [];
        
        // --- QUIZ DATA ---
        const quizzes = {
            week1: { // Dữ liệu vẫn giữ key 'week1' để code hiện tại chạy được
                // ===== BẮT ĐẦU NỘI DUNG THAY THẾ =====
                title: "CHỦ ĐỀ 3: PHẢN XẠ AN TOÀN", 
                description: "Hiểu rõ các tình huống nguy hiểm và Quy tắc 3B.", 
                theory: `
                    <div class="theory-section">
                        <h4 class="text-xl font-bold mb-3 text-purple-700">Câu chuyện thật 👩‍💻 💬</h4>
                        <p class="mb-4 bg-purple-100 p-3 rounded-lg">Một buổi tối, H. nhận được tin nhắn từ người lạ: “Nếu mày không gửi cho tao 2 triệu đồng, tao sẽ tung ảnh riêng tư của mày lên mạng.”<br>Hoảng sợ, H. không dám nói với ai, vội vàng chuyển tiền. Nhưng vài ngày sau, người đó lại tiếp tục đòi thêm. Lúc này, H. mới kể cho mẹ và giáo viên chủ nhiệm. Nhờ giữ lại tin nhắn, cơ quan công an đã truy ra kẻ tống tiền.</p>
                        <p class="font-bold">💭 Em có nhận ra điều gì sai trong cách phản ứng ban đầu của bạn H. không?</p>
                        <p class="mt-2">👉 Bạn đã quá sợ hãi và hành động một mình, khiến kẻ xấu càng lấn tới. Khi bị đe dọa, việc quan trọng không phải là “làm theo cho xong”, mà là biết phản xạ an toàn.</p>
                    </div>

                    <div class="theory-section">
                        <h4 class="text-purple-700">1. Những tình huống nguy hiểm thường gặp</h4>
                        <p>Không chỉ H., rất nhiều học sinh khác cũng có thể trở thành nạn nhân nếu thiếu cảnh giác. Dưới đây là các tình huống phổ biến mà em cần nhận diện sớm:</p>
                        
                        <h5 class="font-semibold text-purple-600 mt-2">🕵️ Tin nhắn đe dọa, tống tiền</h5>
                        <p>Kẻ xấu dùng ảnh, video, hoặc thông tin cá nhân của em để ép buộc. Chúng có thể nói:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 italic">
                            <li>“Tao có ảnh riêng tư của mày.”</li>
                            <li>“Nếu không gửi tiền, tao sẽ đăng hết lên mạng.”</li>
                        </ul>
                        <p class="mt-2"><b>📎 Thực tế:</b> Có trường hợp học sinh bị dụ gửi ảnh cá nhân, rồi bị đe dọa đăng lên mạng để tống tiền. Nhiều bạn sợ hãi, làm theo yêu cầu, khiến tình hình nghiêm trọng hơn.</p>

                        <h5 class="font-semibold text-purple-600 mt-2">👤 Người lạ giả danh người quen</h5>
                        <p>Kẻ xấu tạo tài khoản giống hệt bạn bè hoặc giáo viên, sau đó nhắn:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 italic">
                            <li>“Cho mình mượn chút tiền nhé.”</li>
                            <li>“Cô đang cần xác minh danh sách học sinh, em gửi mã OTP giúp cô.”</li>
                        </ul>
                        <p class="mt-2">📱 Nếu em thấy tin nhắn “lạ mà quen”, hãy gọi điện trực tiếp để xác minh – đừng tin vào hình đại diện hay tên hiển thị. Có thể chỉ mất vài giây, nhưng sẽ cứu em khỏi một vụ lừa đảo.</p>

                        <h5 class="font-semibold text-purple-600 mt-2">💬 Bị nói xấu, bôi nhọ hoặc xúc phạm trên mạng</h5>
                        <p>Đôi khi, có người đăng bài châm chọc, bịa chuyện, hoặc cắt ghép hình ảnh của em để chế giễu. Những hành động ấy được gọi là bắt nạt trực tuyến (cyberbullying).</p>
                        <p class="mt-2">🧠 Tổn thương do bắt nạt mạng không nhìn thấy bằng mắt, nhưng nó gây đau đớn và sợ hãi thật sự – giống như bị tổn thương ngoài đời. Nếu gặp chuyện này, đừng im lặng – hãy tìm người giúp đỡ.</p>
                    </div>

                    <div class="theory-section">
                        <h4 class="text-purple-700">2. Quy tắc 3B – Bình tĩnh – Báo người lớn – Bảo lưu chứng cứ</h4>
                        <p>Đây là ba bước phản xạ quan trọng giúp em xử lý tình huống nguy hiểm một cách an toàn và thông minh.</p>

                        <h5 class="font-semibold text-purple-600 mt-2">Bước 1: Bình tĩnh</h5>
                        <p class="font-bold">“Dừng lại, hít sâu, nghĩ kỹ.”</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>Tuyệt đối không trả lời tin nhắn đe dọa, không cãi lại, không gửi ảnh, không chuyển tiền.</li>
                            <li>Kẻ xấu thường muốn em sợ hãi để điều khiển – nên việc giữ bình tĩnh là cách làm chủ đầu tiên.</li>
                            <li>Đọc kỹ tin nhắn: nếu thấy từ ngữ đe dọa, gấp gáp, hoặc kêu gọi hành động ngay – đó là dấu hiệu của lừa đảo hoặc uy hiếp tâm lý.</li>
                        </ul>
                        <p class="mt-2"><b>📍 Mẹo:</b> Khi thấy tim đập nhanh, hãy tắt màn hình, uống nước, hít sâu 3 lần – rồi mới nghĩ đến bước tiếp theo.</p>

                        <h5 class="font-semibold text-purple-600 mt-2">Bước 2: Báo người lớn</h5>
                        <p class="font-bold">“Khi sợ hãi – hãy nói, đừng giấu.”</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>Báo ngay cho cha mẹ, giáo viên chủ nhiệm, tổng phụ trách hoặc thầy cô tin cậy.</li>
                            <li>Nếu tình huống nghiêm trọng (đe dọa, tống tiền, phát tán ảnh riêng tư) – gọi ngay 111, đường dây nóng quốc gia bảo vệ trẻ em (24/7 – miễn phí).</li>
                            <li>Trường hợp khẩn cấp: báo công an hoặc cơ quan an ninh mạng địa phương.</li>
                        </ul>
                        <p class="mt-2 font-bold">📞 Số cần nhớ:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>111 – Bảo vệ trẻ em</li>
                            <li>113 – Cảnh sát phản ứng nhanh</li>
                            <li>1900 0368 – Hỗ trợ tư vấn tâm lý học đường</li>
                        </ul>
                        <p class="mt-2 italic">💬 Khi em nói ra, em không yếu đuối – mà là đang tự bảo vệ mình.</p>

                        <h5 class="font-semibold text-purple-600 mt-2">Bước 3: Bảo lưu chứng cứ</h5>
                        <p class="font-bold">“Giữ lại dấu vết để công lý bảo vệ em.”</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>Chụp màn hình, lưu lại đường link, thời gian, nội dung tin nhắn.</li>
                            <li>Không xóa cuộc trò chuyện, vì đó là bằng chứng giúp công an điều tra.</li>
                            <li>Nếu là bài viết công khai, báo cáo (Report) và chặn tài khoản của người gây hại.</li>
                        </ul>
                        <p class="mt-2"><b>📎 Ví dụ thực tế:</b> Khi có người nhắn “Nếu không gửi tiền, tao tung ảnh mày”, em hãy chụp lại màn hình, chặn người đó, và báo cho thầy cô ngay. Việc em lưu giữ chứng cứ có thể giúp ngăn chặn nhiều vụ tội phạm khác.</p>
                    </div>

                    <div class="theory-section">
                        <h4 class="text-purple-700">3. Hỗ trợ bạn bè khi gặp nguy hiểm</h4>
                        <p class="font-bold">“Đừng để bạn mình chiến đấu một mình trên mạng.”</p>
                        <p>Nếu em thấy bạn bị xúc phạm, bôi nhọ hay tấn công online:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>Đừng im lặng. Im lặng có thể khiến bạn cảm thấy cô đơn.</li>
                            <li>Đừng bình luận hùa theo, dù chỉ là đùa.</li>
                            <li>An ủi bạn, giúp bạn báo cáo bài viết, hướng dẫn liên hệ thầy cô hoặc người lớn.</li>
                        </ul>
                        <p class="mt-2 italic">💬 Một lời hỏi han cũng là một chiếc phao cứu sinh trên mạng.</p>
                    </div>

                    <div class="theory-section">
                        <h4 class="text-purple-700">4. Kỹ năng phản xạ an toàn nâng cao</h4>
                        <p>“Phản xạ an toàn” không phải là biết đánh trả, mà là biết bình tĩnh – biết dừng lại – biết tìm người trợ giúp đúng lúc. Ngoài 3B, em có thể áp dụng thêm 3 mẹo “SMART”:</p>
                        <table class="theory-table">
                            <thead>
                                <tr>
                                    <th>Kỹ năng</th>
                                    <th>Ý nghĩa</th>
                                    <th>Ứng dụng</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>S – Stop (Dừng lại)</td>
                                    <td>Không phản ứng ngay khi hoảng sợ</td>
                                    <td>Tắt điện thoại, ra khỏi ứng dụng để trấn tĩnh</td>
                                </tr>
                                <tr>
                                    <td>M – Move (Chia sẻ)</td>
                                    <td>Tìm người tin cậy để kể lại</td>
                                    <td>Gọi thầy cô, cha mẹ, hoặc bạn thân</td>
                                </tr>
                                <tr>
                                    <td>A – Archive (Lưu chứng cứ)</td>
                                    <td>Giữ mọi hình ảnh, đoạn chat</td>
                                    <td>Chụp màn hình, gửi vào thư mục an toàn</td>
                                </tr>
                                <tr>
                                    <td>R – Report (Báo cáo)</td>
                                    <td>Báo lên mạng xã hội hoặc công an</td>
                                    <td>Dùng tính năng “Report”, gọi 111</td>
                                </tr>
                                <tr>
                                    <td>T – Trust (Tin tưởng)</td>
                                    <td>Tin rằng mình có thể được giúp</td>
                                    <td>Không tự chịu đựng hay giấu giếm</td>
                                </tr>
                            </tbody>
                        </table>
                        <p class="mt-4">“Phản xạ an toàn” không chỉ là kỹ năng xử lý tình huống, mà còn là sức mạnh tinh thần – giúp em giữ bình tĩnh, sáng suốt, và tin tưởng rằng mình không một mình.</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-2 font-semibold">
                            <li>Bình tĩnh để không sập bẫy.</li>
                            <li>Báo người lớn để không đơn độc.</li>
                            <li>Giữ chứng cứ để bảo vệ công lý.</li>
                        </ul>
                    </div>
                    
                    <div class="theory-section text-center">
                        <h4 class="text-xl font-bold mt-6 mb-3 text-blue-800">🌈 Thông điệp tuần 3 – “Phản xạ an toàn”</h4>
                        <p class="mt-2 font-bold text-blue-800 text-lg">“Khi gặp nguy hiểm – hãy phản xạ an toàn, không phản ứng vội.<br>Mỗi hành động bình tĩnh là một tấm khiên bảo vệ bản thân và người khác.”</p>
                    </div>
                `,
                questions: [ 
                    { type: 'mcq', question: "Câu 1. Khi nhận được tin nhắn đe dọa “Nếu không gửi tiền, tao tung ảnh của mày lên mạng”, em nên làm gì đầu tiên?", options: ["A. Trả lời để xin họ xóa ảnh", "B. Xóa tin nhắn cho đỡ sợ", "C. Bình tĩnh, chụp màn hình làm bằng chứng", "D. Chuyển tiền để tránh bị tung ảnh"], answer: "C. Bình tĩnh, chụp màn hình làm bằng chứng" },
                    { type: 'mcq', question: "Câu 2. Hành động nào sau đây không đúng khi giúp bạn bị nói xấu trên mạng?", options: ["A. Báo cáo bài viết sai sự thật", "B. Động viên, khuyên bạn tìm người giúp đỡ", "C. Bình luận lại để “bênh” bạn bằng lời lẽ gay gắt", "D. Giữ lại hình ảnh làm bằng chứng"], answer: "C. Bình luận lại để “bênh” bạn bằng lời lẽ gay gắt" },
                    { type: 'mcq', question: "Câu 3. Quy tắc 3B trong bài “Phản xạ an toàn” gồm những gì?", options: ["A. Bình tĩnh – Bỏ qua – Báo người lạ", "B. Bình tĩnh – Báo người lớn – Bảo lưu chứng cứ", "C. Bỏ chạy – Báo công an – Bật mạng xã hội", "D. Bình tĩnh – Bảo mật – Báo cảnh sát"], answer: "B. Bình tĩnh – Báo người lớn – Bảo lưu chứng cứ" },
                    { type: 'mcq', question: "Câu 4. Số điện thoại đường dây nóng bảo vệ trẻ em mà học sinh có thể gọi khi bị đe dọa hoặc quấy rối là số nào?", options: ["A. 111", "B. 113", "C. 115", "D. 1900 0368"], answer: "A. 111" },
                    { type: 'mcq', question: "Câu 5. Vì sao không nên xóa tin nhắn hoặc bài viết khi bị đe dọa, tống tiền?", options: ["A. Vì xóa sẽ khiến người kia tức giận hơn", "B. Vì đó là bằng chứng quan trọng để báo cơ quan chức năng", "C. Vì mạng xã hội không cho phép xóa tin", "D. Vì bạn bè có thể cần xem lại"], answer: "B. Vì đó là bằng chứng quan trọng để báo cơ quan chức năng" }
                ]
                // ===== KẾT THÚC NỘI DUNG THAY THẾ =====
            },
        };

        // --- FUNCTIONS ---
        function showView(viewToShow) {
            [registrationView, theoryView, quizView].forEach(view => view.classList.add('hidden'));
            viewToShow.classList.remove('hidden');
        }

        function showTheory(week) {
            currentQuiz = quizzes[week];
            userAnswers = new Array(currentQuiz.questions.length).fill(null);
            theoryTitle.textContent = `Kiến thức ${currentQuiz.title}`; 
            theoryContent.innerHTML = currentQuiz.theory;
            showView(theoryView);
        }

        function displayQuiz() {
            document.getElementById('quiz-title').textContent = currentQuiz.title; 
            document.getElementById('quiz-description').textContent = currentQuiz.description; 
            quizContainer.innerHTML = '';
            currentQuiz.questions.forEach((q, index) => {
                const qElem = document.createElement('div');
                qElem.className = 'border-b pb-4';
                qElem.id = `question-${index}`;
                qElem.style.display = 'block';

                let contentHTML = `<p class="font-semibold text-lg mb-2">${q.question}</p>`;
                if (q.type === 'mcq') {
                    contentHTML += `<div class="space-y-2">` + q.options.map(opt => `<div class="quiz-option border rounded-lg p-3 cursor-pointer mt-2" data-q-index="${index}" data-option="${opt}">${opt}</div>`).join('') + `</div>`;
                }
                qElem.innerHTML = contentHTML;
                quizContainer.appendChild(qElem);
            });

            document.querySelectorAll('.quiz-option').forEach(el => {
                el.addEventListener('click', e => {
                    const qIndex = parseInt(e.currentTarget.dataset.qIndex);
                    const option = e.currentTarget.dataset.option;
                    userAnswers[qIndex] = option;
                    document.querySelectorAll(`.quiz-option[data-q-index="${qIndex}"]`).forEach(opt => opt.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                });
            });
        }


        function submitQuiz() {
            submitQuizBtn.disabled = true;
            quizContainer.classList.add('submitted');
            let score = 0;
            let totalScorable = 0;
            currentQuiz.questions.forEach((q, index) => {
                if (q.type === 'mcq' && q.answer) {
                    totalScorable++;
                    if (userAnswers[index] === q.answer) score++;
                    document.querySelectorAll(`.quiz-option[data-q-index="${index}"]`).forEach(opt => {
                        const optionText = opt.dataset.option;
                        if (optionText === q.answer) opt.classList.add('correct');
                        else if (optionText === userAnswers[index]) opt.classList.add('incorrect');
                    });
                }
            });
            const percentage = totalScorable > 0 ? Math.round((score / totalScorable) * 100) : 100;
            // Gửi 'week2' sang Google Apps Script
            saveDataToGoogleSheets("week2", percentage); 
            setTimeout(() => showResult(percentage), 1500); 
        }

        function showResult(percentage) {
            showView(quizView); 
            resultModal.classList.remove('hidden');
            setTimeout(() => resultContent.classList.remove('scale-95', 'opacity-0'), 100);

            document.getElementById('result-score').innerHTML = `Điểm trắc nghiệm: <strong>${percentage}%</strong>`;
            
            const robotCongratsEl = document.getElementById('robot-congrats-text');
            const messageEl = document.getElementById('result-message');
            const titleEl = document.getElementById('result-title');
            const cupContainer = document.getElementById('cup-container');

            // Thay đổi điều kiện thành >= 60
            if (percentage >= 60) { 
                titleEl.textContent = "Xuất sắc!";
                cupContainer.style.display = 'block';
                triggerFireworks();
                
                normalResultContent.classList.add('hidden');
                robotMessageContent.classList.remove('hidden');
                robotCongratsEl.textContent = `UKA Hạ Long chúc mừng ${studentInfo.name} đã vượt qua thử thách và đạt được huy hiệu tuần “Chiến binh an toàn số”!`;
            } else {
                titleEl.textContent = "Cố gắng hơn nhé!";
                messageEl.textContent = `Hãy ôn lại kiến thức và thử lại nhé, ${studentInfo.name}!`;
                cupContainer.style.display = 'none';
                normalResultContent.classList.remove('hidden');
                robotMessageContent.classList.add('hidden');
            }
        }

        function triggerFireworks() {
            const duration = 4 * 1000; // Run for 4 seconds
            const animationEnd = Date.now() + duration;
            const myConfetti = confetti.create(fireworksCanvas, {
                resize: true,
                useWorker: true
            });

            const colors = ['#00529D', '#FFD700', '#FFFFFF', '#4169E1', '#FF6347', '#32CD32'];

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                
                myConfetti({
                    startVelocity: 30, spread: 360, ticks: 60, zIndex: 100, particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }, colors: colors
                });
                myConfetti({
                    startVelocity: 30, spread: 360, ticks: 60, zIndex: 100, particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }, colors: colors
                });
            }, 250);
        }
        
        async function saveDataToGoogleSheets(week, score) {
             const scriptURL = 'https://script.google.com/macros/s/AKfycbx7ncf7mNXbsFJFbh_p8bU-AdBC8VYiFROj5cZfS8BLMF6Se2Ksp0zcF_Qj4UaTzgXApQ/exec'; // Link thầy đã cung cấp
            const formData = new FormData();
            formData.append('Hoten', studentInfo.name);
            formData.append('Email', studentInfo.email);
            formData.append('Lop', studentInfo.class);
            formData.append('Tuan', week); // Gửi mã tuần ('week2')
            formData.append('Diemso', score);
            try {
                 await fetch(scriptURL, { method: 'POST', body: formData });
            } catch (error) {
                console.error('Lỗi khi gửi dữ liệu:', error.message);
            }
        }
        
        function resetApp() {
            resultModal.classList.add('hidden');
            quizContainer.classList.remove('submitted');
            submitQuizBtn.disabled = false;
            normalResultContent.classList.remove('hidden');
            robotMessageContent.classList.add('hidden');
            showView(registrationView);
        }

        function retryFromTheory() {
            resultModal.classList.add('hidden');
            quizContainer.classList.remove('submitted');
            submitQuizBtn.disabled = false;
            // Luôn quay lại 'week1' vì đó là key duy nhất chứa nội dung
            showTheory('week1'); 
        }

        // --- EVENT LISTENERS ---
        registrationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            studentInfo.name = document.getElementById('student-name').value;
            studentInfo.email = document.getElementById('student-email').value;
            studentInfo.class = document.getElementById('student-class').value;
            if (!studentInfo.name || !studentInfo.email || !studentInfo.class) {
                alert('Vui lòng điền đầy đủ thông tin.');
                return;
            }
            // Luôn hiển thị nội dung của 'week1' vì đã gộp
            showTheory('week1'); 
        });

        startQuizBtn.addEventListener('click', () => {
            showView(quizView);
            displayQuiz();
        });

        submitQuizBtn.addEventListener('click', submitQuiz);
        closeModalBtn.addEventListener('click', resetApp);
        continueBtn.addEventListener('click', resetApp);
        continueBtnFail.addEventListener('click', retryFromTheory);

        const shareOnFacebook = () => {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(`"${studentInfo.name}" đã đạt danh hiệu "Chiến binh an toàn số" trong chiến dịch Không Một Mình!`);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
        };
        
        const shareOnZalo = () => {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://zalo.me/share/link?url=${url}`, '_blank');
        };
        
        document.querySelectorAll('#share-fb-2').forEach(btn => btn.addEventListener('click', shareOnFacebook));
        document.querySelectorAll('#share-zalo-2').forEach(btn => btn.addEventListener('click', shareOnZalo));

    </script>
</body>
</html>


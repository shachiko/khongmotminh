<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Không Một Mình – Cùng nhau an toàn trực tuyến</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
        }
        .quiz-option:hover {
            background-color: #DBEAFE; /* Light blue on hover */
        }
        .quiz-option.selected {
            background-color: #93C5FD; /* Darker blue when selected */
            border-color: #2563EB;
        }
        .quiz-option.correct {
            background-color: #D1FAE5;
            border-color: #059669;
            color: #047857;
            font-weight: bold;
        }
        .quiz-option.incorrect {
            background-color: #FEE2E2;
            border-color: #E11D48;
            color: #BE123C;
        }
        #quiz-container.submitted .quiz-option {
            pointer-events: none;
            cursor: default;
        }
        /* Style for theory sections */
        .theory-section {
            margin-top: 1.5rem; /* Reduced margin */
            padding-top: 1rem; /* Reduced padding */
            /* border-top: 1px solid #e5e7eb; Removed border for continuous flow */
        }
        .theory-section h4 {
             margin-top: 1.5rem; /* mt-6 */
             margin-bottom: 0.75rem; /* mb-3 */
             font-size: 1.25rem; /* text-xl */
             font-weight: 700; /* font-bold */
        }
         .theory-section h5 {
             margin-top: 1rem; /* mt-4 */
             margin-bottom: 0.5rem; /* mb-2 */
             font-size: 1.125rem; /* text-lg */
             font-weight: 600; /* font-semibold */
        }

    </style>
</head>
<body class="bg-blue-50 text-gray-800 flex flex-col min-h-screen">

    <div id="app" class="container mx-auto p-4 max-w-4xl flex flex-col flex-grow">

        <!-- Header --><header class="text-center my-8">
            <img id="logo" src="logo-tron.png" alt="Logo Không Một Mình" class="w-20 h-20 mx-auto mb-4 rounded-full"
                 onerror="this.onerror=null;this.src='https://placehold.co/100x100/FFFFFF/00529D?text=Logo';">
            <h1 class="text-4xl font-bold text-blue-800">Không Một Mình</h1>
            <p class="text-lg text-blue-600">Cùng nhau an toàn trực tuyến</p>
        </header>

        <main id="main-content" class="flex-grow flex items-center justify-center">
            <!-- Registration View --><div id="registration-view" class="bg-white p-8 rounded-xl shadow-lg text-center w-full">
                 <img id="banner" src="Kmm-01.jpg" alt="Banner Chiến dịch" class="w-full h-64 object-cover rounded-lg mb-6"
                       onerror="this.onerror=null;this.src='https://placehold.co/800x400/00529D/FFFFFF?text=Banner';">
                <h2 class="text-2xl font-bold mb-4">Tham gia Thử thách Bảo vệ</h2>
                <p class="mb-6">Hãy điền thông tin để bắt đầu bài kiểm tra hàng tuần và tích luỹ cúp nhé!</p>
                <form id="registration-form" class="space-y-4 max-w-sm mx-auto">
                    <input type="text" id="student-name" placeholder="Họ và tên của bạn" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="email" id="student-email" placeholder="Email nhận chứng nhận" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="text" id="student-class" placeholder="Lớp" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <!-- Đổi chữ trên nút thành TUẦN 2 -->
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">BẮT ĐẦU TUẦN 2</button>
                </form>
            </div>

            <!-- Theory View --><div id="theory-view" class="hidden bg-white p-8 rounded-xl shadow-lg w-full">
                <h2 id="theory-title" class="text-2xl font-bold mb-4 text-center">Kiến thức Tuần 2</h2> <!-- Cập nhật tiêu đề mặc định -->
                <div id="theory-content" class="text-left mb-6 space-y-4 max-h-[60vh] overflow-y-auto pr-4">
                    <!-- Theory content will be dynamically inserted here -->
                </div>
                <button id="start-quiz-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors">Đã hiểu, Bắt đầu làm bài</button>
            </div>

            <!-- Quiz View --><div id="quiz-view" class="hidden bg-white p-8 rounded-xl shadow-lg w-full">
                <h2 id="quiz-title" class="text-2xl font-bold mb-2 text-center">Bài kiểm tra Tuần 2</h2> <!-- Cập nhật tiêu đề mặc định -->
                <p id="quiz-description" class="text-center mb-6">Chọn câu trả lời đúng nhất.</p>
                <div id="quiz-container" class="space-y-6"></div>
                <button id="submit-quiz" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400">Nộp bài</button>
            </div>
        </main>
    </div>

    <!-- Footer --><footer class="text-center py-6 text-sm text-gray-500">
        <p>&copy; 2025 - Sản phẩm thuộc bản quyền của trường UK ACADEMY HA LONG</p>
    </footer>

    <!-- Result Modal --><div id="result-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full relative transform transition-all scale-95 opacity-0" id="result-content">
            <!-- Normal Result Content --><div id="normal-result-content">
                <h2 id="result-title" class="text-3xl font-bold text-yellow-500 mb-4"></h2>
                <div id="cup-container" class="my-4">
                    <svg class="w-32 h-32 mx-auto text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM8 16a2 2 0 114 0H8z"></path><path fill-rule="evenodd" d="M10 0a1 1 0 011 1v.065a8.002 8.002 0 015.657 5.657A1 1 0 0117 8v3.586l1.707 1.707a1 1 0 01-1.414 1.414L16 13.414V8a6.002 6.002 0 00-5-5.917V1a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                </div>
                <p id="result-message" class="text-xl font-semibold text-gray-700 my-4"></p>
                <p id="result-score" class="text-lg mb-6"></p>
                <button id="continue-btn-fail" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors mt-4">Tiếp tục làm lại</button>
            </div>

            <!-- Robot Message Content (Initially hidden) --><div id="robot-message-content" class="hidden">
                <img src="robot-uka.png" alt="Robot UKA Hạ Long" class="w-40 h-40 mx-auto mb-4 object-contain"
                     onerror="this.onerror=null;this.src='https://placehold.co/150x150/FFFFFF/00529D?text=Robot';">
                <p id="robot-congrats-text" class="text-xl font-bold text-blue-700 mb-4"></p>
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="share-fb-2" class="bg-blue-800 text-white font-bold py-2 px-5 rounded-lg">Chia sẻ Facebook</button>
                    <button id="share-zalo-2" class="bg-blue-500 text-white font-bold py-2 px-5 rounded-lg">Chia sẻ Zalo</button>
                </div>
                <button id="continue-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors mt-4">Tiếp tục</button>
            </div>
            
            <button id="close-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
        </div>
    </div>
    
    <canvas id="fireworks-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script>
        // DOM Elements
        const registrationView = document.getElementById('registration-view');
        const theoryView = document.getElementById('theory-view');
        const quizView = document.getElementById('quiz-view');
        const resultModal = document.getElementById('result-modal');
        const resultContent = document.getElementById('result-content');
        const normalResultContent = document.getElementById('normal-result-content');
        const robotMessageContent = document.getElementById('robot-message-content');
        const registrationForm = document.getElementById('registration-form');
        const quizContainer = document.getElementById('quiz-container');
        const submitQuizBtn = document.getElementById('submit-quiz');
        const closeModalBtn = document.getElementById('close-modal');
        const continueBtn = document.getElementById('continue-btn');
        const continueBtnFail = document.getElementById('continue-btn-fail');
        const fireworksCanvas = document.getElementById('fireworks-canvas');
        const theoryContent = document.getElementById('theory-content');
        const theoryTitle = document.getElementById('theory-title');
        const startQuizBtn = document.getElementById('start-quiz-btn');

        // State
        let studentInfo = { name: '', email: '', class: '' };
        // Giữ nguyên key 'week1' vì chỉ có 1 bộ dữ liệu, nhưng sẽ gửi 'week2' sang Apps Script
        let currentQuizKey = 'week1'; 
        let currentQuiz = {};
        let userAnswers = [];
        
        // --- QUIZ DATA ---
        const quizzes = {
            week1: { // Dữ liệu vẫn giữ key 'week1' để code hiện tại chạy được
                title: "CHỦ ĐỀ 2: NHẬN DIỆN MỐI NGUY", 
                description: "Nhận biết tin giả, deepfake và tin nhắn lừa đảo.", 
                theory: `
                    <div class="theory-section">
                        <h4 class="text-xl font-bold mb-3 text-purple-700">Các em hãy đọc câu chuyện dưới đây</h4>
                        <p class="mb-4 bg-purple-100 p-3 rounded-lg">Một buổi sáng, Linh nhận tin nhắn: “Chúc mừng bạn trúng học bổng 10 triệu đồng từ chương trình Học sinh giỏi toàn quốc. Vui lòng bấm vào đường link dưới đây để nhận thưởng.” Vì tò mò, Linh bấm vào. Vài phút sau, toàn bộ tài khoản mạng xã hội của bạn bị chiếm quyền sử dụng.</p>
                        <p class="font-bold">💭 Em có nhận ra đây là hình thức lừa đảo nào không?</p>
                    </div>

                    <div class="theory-section">
                        <h4 class="text-purple-700">1. Tin giả (Fake News)</h4>
                        <p>🔎 Tin giả là những thông tin sai sự thật, được tạo ra để gây hiểu lầm, thu hút lượt xem hoặc lừa đảo người đọc. Chúng thường lan truyền rất nhanh trên mạng xã hội vì đánh vào sự tò mò hoặc sợ hãi của người xem.</p>
                        <h5 class="font-semibold text-purple-600 mt-2">Dấu hiệu nhận biết tin giả:</h5>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>📍 Tiêu đề giật gân, gây sốc.</li>
                            <li>📍 Không ghi rõ nguồn hoặc nguồn mập mờ.</li>
                            <li>📍 Hình ảnh không liên quan đến nội dung.</li>
                        </ul>
                        <p class="mt-2 italic">📰 Ví dụ: “Nam sinh mất tích do chơi game 72 tiếng” – <a href="https://vietnamnet.vn/game-thu-dai-loan-nam-chet-hang-tieng-dong-ho-trong-quan-net-217731.html" target="_blank" class="text-blue-600 hover:underline">Link tham khảo</a></p>
                    </div>

                    <div class="theory-section">
                        <h4 class="text-purple-700">2. Deepfake – khi hình ảnh biết nói dối</h4>
                        <p>Deepfake là video, hình ảnh hoặc giọng nói giả mạo được tạo bằng trí tuệ nhân tạo (AI). Kẻ xấu có thể ghép mặt một người vào video nhạy cảm, hoặc giả giọng để lừa người thân chuyển tiền.</p>
                        <h5 class="font-semibold text-purple-600 mt-2">🎭 Deepfake nguy hiểm vì:</h5>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>Nhìn – nghe rất giống thật, khó phân biệt bằng mắt thường.</li>
                            <li>Có thể làm tổn thương danh dự, uy tín của người bị hại.</li>
                        </ul>
                        <h5 class="font-semibold text-purple-600 mt-2">Mẹo kiểm tra:</h5>
                         <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>Nếu hình ảnh “giống thật nhưng hơi kỳ lạ” (ánh sáng sai, chuyển động méo, giọng nói không tự nhiên) → hãy dừng lại và xác minh.</li>
                            <li>Dùng công cụ tìm kiếm hình ảnh ngược (Google Reverse Image Search) hoặc hỏi người lớn, thầy cô.</li>
                        </ul>
                        <p class="mt-2 font-bold text-red-600">⚠️ Đừng tin ngay cả khi “mắt thấy tai nghe” – hãy tin khi đã kiểm chứng!</p>
                    </div>

                     <div class="theory-section">
                        <h4 class="text-purple-700">3. Tin nhắn lừa đảo (Phishing Messages)</h4>
                        <p>Kẻ xấu thường gửi tin nhắn với nội dung hấp dẫn hoặc khẩn cấp để đánh lừa người nhận:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 italic">
                            <li>📨 “Bạn trúng thưởng lớn!”</li>
                            <li>📨 “Cần xác minh tài khoản ngay để tránh bị khóa.”</li>
                            <li>📨 “Bấm vào đây nhận quà sinh nhật miễn phí.”</li>
                        </ul>
                        <p class="mt-2">Sau khi người nhận nhấn vào liên kết, trang web giả mạo sẽ:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">
                            <li>Yêu cầu đăng nhập tài khoản,</li>
                            <li>Gửi mã OTP,</li>
                            <li>Hoặc cài phần mềm lấy cắp thông tin.</li>
                         </ul>
                         <p class="mt-2 font-bold text-red-600">🚫 Không bao giờ nhấn vào link lạ hoặc cung cấp mã OTP cho bất kỳ ai. Ngân hàng, trường học, hay Bộ Công an không bao giờ yêu cầu xác minh qua link nhắn tin.</p>
                     </div>

                     <div class="theory-section">
                         <h4 class="text-purple-700">4. Ứng xử an toàn khi gặp thông tin đáng ngờ</h4>
                         <p class="font-bold text-green-700">💡 Trước khi chia sẻ – hãy kiểm tra!</p>
                         <ol class="list-decimal list-inside space-y-1 pl-4 mt-2">
                             <li><b>Kiểm chứng nguồn:</b> Xem thông tin có xuất phát từ báo chính thống (Báo Chính phủ, VNExpress, Dân trí, VOV, ANTĐ...) hay không.</li>
                             <li><b>Đọc kỹ nội dung:</b> Nếu quá bất thường, thiếu logic hoặc giật gân, khả năng cao là tin giả.</li>
                             <li><b>Hỏi người đáng tin:</b> GVCN, cha mẹ hoặc bạn học giỏi công nghệ.</li>
                             <li><b>Không lan truyền:</b> Nếu chưa chắc chắn, đừng chia sẻ.</li>
                             <li><b>Báo cáo nội dung xấu:</b> Dùng tính năng “Báo cáo / Report” trên Facebook, TikTok, Zalo.</li>
                         </ol>
                     </div>

                    <div class="theory-section">
                        <h4 class="text-purple-700">💬 Câu hỏi gợi mở</h4>
                        <ol class="list-decimal list-inside space-y-1 pl-4">
                            <li>Theo em, vì sao con người dễ tin vào tin giả hơn là tin thật?</li>
                            <li>Em đã từng thấy video deepfake hay tin giả nào lan nhanh trên mạng chưa? Em nhận ra nó bằng cách nào?</li>
                            <li>Khi có bạn gửi tin “trúng thưởng”, em sẽ làm gì để không bị lừa?</li>
                        </ol>
                    </div>

                    <div class="theory-section">
                        <h4 class="text-xl font-bold mt-6 mb-3 text-green-700">🌈 Em cần ghi nhớ</h4>
                        <ul class="list-disc list-inside space-y-1 pl-4 font-semibold">
                            <li>Tin giả, deepfake và tin nhắn lừa đảo đều có thể làm hại danh dự, tài sản và uy tín của người khác.</li>
                            <li>Hãy luôn kiểm chứng – cảnh giác – chia sẻ có trách nhiệm.</li>
                            <li>Trước khi bấm “Chia sẻ”, hãy nhớ:</li>
                        </ul>
                        <p class="mt-2 font-bold text-center text-lg">🧭 “Dừng lại một giây – để an toàn cho mọi người.”</p>
                    </div>

                    <div class="theory-section text-center">
                        <h4 class="text-xl font-bold mt-6 mb-3 text-blue-800">🌐 THÔNG ĐIỆP TUẦN 2 – “NHẬN DIỆN MỐI NGUY”</h4>
                        <p class="mt-2 font-bold text-blue-800 text-lg">“Không tin vội, không chia sẻ bừa.<br>Mỗi cú click cẩn trọng – là một hành động bảo vệ cộng đồng mạng.”</p>
                    </div>
                `,
                questions: [ 
                    { type: 'mcq', question: "Câu 1: Dấu hiệu của tin giả là:", options: ["A. Có nguồn rõ", "B. Giật tít gây sốc, thiếu kiểm chứng", "C. Trích dẫn đầy đủ", "D. Có dấu xác thực"], answer: "B. Giật tít gây sốc, thiếu kiểm chứng" },
                    { type: 'mcq', question: "Câu 2: Khi nhận tin nhắn trúng thưởng, em nên:", options: ["A. Bấm link ngay", "B. Chia sẻ bạn bè", "C. Báo cha mẹ/GVCN hoặc xoá tin nhắn", "D. Điền thông tin cá nhân"], answer: "C. Báo cha mẹ/GVCN hoặc xoá tin nhắn" },
                    { type: 'mcq', question: "Câu 3: Deepfake là:", options: ["A. Ảnh hoặc video bị chỉnh sửa giả mạo người thật", "B. Video chất lượng cao", "C. Video vui", "D. File virus"], answer: "A. Ảnh hoặc video bị chỉnh sửa giả mạo người thật" },
                    { type: 'mcq', question: "Câu 4: Khi người lạ kết bạn qua mạng, em nên:", options: ["A. Chấp nhận ngay", "B. Kiểm tra thông tin, bạn chung trước khi đồng ý", "C. Trò chuyện thêm", "D. Gửi ảnh"], answer: "B. Kiểm tra thông tin, bạn chung trước khi đồng ý" },
                    { type: 'mcq', question: "Câu 5: Khi phát hiện tin giả lan truyền, em nên:", options: ["A. Chia sẻ thêm để cảnh báo", "B. Báo cáo bài viết và bình luận “tin giả”", "C. Không làm gì", "D. Tạo bài phản đối"], answer: "B. Báo cáo bài viết và bình luận “tin giả”" }
                ]
            },
        };

        // --- FUNCTIONS ---
        function showView(viewToShow) {
            [registrationView, theoryView, quizView].forEach(view => view.classList.add('hidden'));
            viewToShow.classList.remove('hidden');
        }

        function showTheory(week) {
            currentQuiz = quizzes[week];
            userAnswers = new Array(currentQuiz.questions.length).fill(null);
            theoryTitle.textContent = `Kiến thức ${currentQuiz.title}`; 
            theoryContent.innerHTML = currentQuiz.theory;
            showView(theoryView);
        }

        function displayQuiz() {
            document.getElementById('quiz-title').textContent = currentQuiz.title; 
            document.getElementById('quiz-description').textContent = currentQuiz.description; 
            quizContainer.innerHTML = '';
            currentQuiz.questions.forEach((q, index) => {
                const qElem = document.createElement('div');
                qElem.className = 'border-b pb-4';
                qElem.id = `question-${index}`;
                qElem.style.display = 'block';

                let contentHTML = `<p class="font-semibold text-lg mb-2">${q.question}</p>`;
                if (q.type === 'mcq') {
                    contentHTML += `<div class="space-y-2">` + q.options.map(opt => `<div class="quiz-option border rounded-lg p-3 cursor-pointer mt-2" data-q-index="${index}" data-option="${opt}">${opt}</div>`).join('') + `</div>`;
                }
                qElem.innerHTML = contentHTML;
                quizContainer.appendChild(qElem);
            });

            document.querySelectorAll('.quiz-option').forEach(el => {
                el.addEventListener('click', e => {
                    const qIndex = parseInt(e.currentTarget.dataset.qIndex);
                    const option = e.currentTarget.dataset.option;
                    userAnswers[qIndex] = option;
                    document.querySelectorAll(`.quiz-option[data-q-index="${qIndex}"]`).forEach(opt => opt.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                });
            });
        }


        function submitQuiz() {
            submitQuizBtn.disabled = true;
            quizContainer.classList.add('submitted');
            let score = 0;
            let totalScorable = 0;
            currentQuiz.questions.forEach((q, index) => {
                if (q.type === 'mcq' && q.answer) {
                    totalScorable++;
                    if (userAnswers[index] === q.answer) score++;
                    document.querySelectorAll(`.quiz-option[data-q-index="${index}"]`).forEach(opt => {
                        const optionText = opt.dataset.option;
                        if (optionText === q.answer) opt.classList.add('correct');
                        else if (optionText === userAnswers[index]) opt.classList.add('incorrect');
                    });
                }
            });
            const percentage = totalScorable > 0 ? Math.round((score / totalScorable) * 100) : 100;
            // Gửi 'week2' sang Google Apps Script
            saveDataToGoogleSheets("week2", percentage); 
            setTimeout(() => showResult(percentage), 1500); 
        }

        function showResult(percentage) {
            showView(quizView); 
            resultModal.classList.remove('hidden');
            setTimeout(() => resultContent.classList.remove('scale-95', 'opacity-0'), 100);

            document.getElementById('result-score').innerHTML = `Điểm trắc nghiệm: <strong>${percentage}%</strong>`;
            
            const robotCongratsEl = document.getElementById('robot-congrats-text');
            const messageEl = document.getElementById('result-message');
            const titleEl = document.getElementById('result-title');
            const cupContainer = document.getElementById('cup-container');

            // Thay đổi điều kiện thành >= 60
            if (percentage >= 60) { 
                titleEl.textContent = "Xuất sắc!";
                cupContainer.style.display = 'block';
                triggerFireworks();
                
                normalResultContent.classList.add('hidden');
                robotMessageContent.classList.remove('hidden');
                robotCongratsEl.textContent = `UKA Hạ Long chúc mừng ${studentInfo.name} đã vượt qua thử thách và đạt được huy hiệu tuần “Chiến binh an toàn số”!`;
            } else {
                titleEl.textContent = "Cố gắng hơn nhé!";
                messageEl.textContent = `Hãy ôn lại kiến thức và thử lại nhé, ${studentInfo.name}!`;
                cupContainer.style.display = 'none';
                normalResultContent.classList.remove('hidden');
                robotMessageContent.classList.add('hidden');
            }
        }

        function triggerFireworks() {
            const duration = 4 * 1000; // Run for 4 seconds
            const animationEnd = Date.now() + duration;
            const myConfetti = confetti.create(fireworksCanvas, {
                resize: true,
                useWorker: true
            });

            const colors = ['#00529D', '#FFD700', '#FFFFFF', '#4169E1', '#FF6347', '#32CD32'];

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                
                myConfetti({
                    startVelocity: 30, spread: 360, ticks: 60, zIndex: 100, particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }, colors: colors
                });
                myConfetti({
                    startVelocity: 30, spread: 360, ticks: 60, zIndex: 100, particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }, colors: colors
                });
            }, 250);
        }
        
        async function saveDataToGoogleSheets(week, score) {
             const scriptURL = 'https://script.google.com/macros/s/AKfycbx7ncf7mNXbsFJFbh_p8bU-AdBC8VYiFROj5cZfS8BLMF6Se2Ksp0zcF_Qj4UaTzgXApQ/exec'; // Link thầy đã cung cấp
            const formData = new FormData();
            formData.append('Hoten', studentInfo.name);
            formData.append('Email', studentInfo.email);
            formData.append('Lop', studentInfo.class);
            formData.append('Tuan', week); // Gửi mã tuần ('week2')
            formData.append('Diemso', score);
            try {
                 await fetch(scriptURL, { method: 'POST', body: formData });
            } catch (error) {
                console.error('Lỗi khi gửi dữ liệu:', error.message);
            }
        }
        
        function resetApp() {
            resultModal.classList.add('hidden');
            quizContainer.classList.remove('submitted');
            submitQuizBtn.disabled = false;
            normalResultContent.classList.remove('hidden');
            robotMessageContent.classList.add('hidden');
            showView(registrationView);
        }

        function retryFromTheory() {
            resultModal.classList.add('hidden');
            quizContainer.classList.remove('submitted');
            submitQuizBtn.disabled = false;
            // Luôn quay lại 'week1' vì đó là key duy nhất chứa nội dung
            showTheory('week1'); 
        }

        // --- EVENT LISTENERS ---
        registrationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            studentInfo.name = document.getElementById('student-name').value;
            studentInfo.email = document.getElementById('student-email').value;
            studentInfo.class = document.getElementById('student-class').value;
            if (!studentInfo.name || !studentInfo.email || !studentInfo.class) {
                alert('Vui lòng điền đầy đủ thông tin.');
                return;
            }
            // Luôn hiển thị nội dung của 'week1' vì đã gộp
            showTheory('week1'); 
        });

        startQuizBtn.addEventListener('click', () => {
            showView(quizView);
            displayQuiz();
        });

        submitQuizBtn.addEventListener('click', submitQuiz);
        closeModalBtn.addEventListener('click', resetApp);
        continueBtn.addEventListener('click', resetApp);
        continueBtnFail.addEventListener('click', retryFromTheory);

        const shareOnFacebook = () => {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(`"${studentInfo.name}" đã đạt danh hiệu "Chiến binh an toàn số" trong chiến dịch Không Một Mình!`);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
        };
        
        const shareOnZalo = () => {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://zalo.me/share/link?url=${url}`, '_blank');
        };
        
        document.querySelectorAll('#share-fb-2').forEach(btn => btn.addEventListener('click', shareOnFacebook));
        document.querySelectorAll('#share-zalo-2').forEach(btn => btn.addEventListener('click', shareOnZalo));

    </script>
</body>
</html>

